{% extends "base.html" %}

{% block title %}{{ app_name }} - טעינת טקסט{% endblock %}

{% block content %}
<div x-data="uploadApp()">
    <!-- Header -->
    <div class="mb-8 fade-in">
        <h1 class="text-3xl font-bold text-slate-800 mb-2">טעינת טקסט</h1>
        <p class="text-slate-500">הוסף טקסטים חדשים לניתוח</p>
    </div>
    
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Text Input Form -->
        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6 slide-in">
            <h2 class="text-lg font-semibold text-slate-700 mb-4 flex items-center gap-2">
                <svg class="w-5 h-5 text-sky-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                </svg>
                הזנת טקסט
            </h2>
            
            <div class="space-y-4">
                <!-- Source Name -->
                <div>
                    <label class="block text-sm font-medium text-slate-600 mb-1">שם המקור</label>
                    <input type="text" x-model="sourceName" 
                           class="w-full px-4 py-2.5 rounded-xl border border-slate-200 focus:border-sky-500 focus:ring-2 focus:ring-sky-500/20 outline-none transition-all"
                           placeholder="לדוגמה: ספר בראשית">
                </div>
                
                <!-- Category -->
                <div>
                    <label class="block text-sm font-medium text-slate-600 mb-1">קטגוריה (אופציונלי)</label>
                    <input type="text" x-model="category" 
                           class="w-full px-4 py-2.5 rounded-xl border border-slate-200 focus:border-sky-500 focus:ring-2 focus:ring-sky-500/20 outline-none transition-all"
                           placeholder="לדוגמה: תנ״ך">
                </div>
                
                <!-- Text Input -->
                <div>
                    <label class="block text-sm font-medium text-slate-600 mb-1">טקסט לניתוח</label>
                    <textarea x-model="textContent" 
                              class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:border-sky-500 focus:ring-2 focus:ring-sky-500/20 outline-none transition-all hebrew-text resize-none"
                              rows="10"
                              placeholder="הדבק כאן טקסט עברי עם ניקוד..."></textarea>
                </div>
                
                <!-- Submit Button -->
                <button @click="submitText()" 
                        :disabled="loading || !textContent.trim()"
                        class="w-full btn-primary px-6 py-3 bg-gradient-to-r from-sky-500 to-sky-600 hover:from-sky-600 hover:to-sky-700 disabled:from-slate-300 disabled:to-slate-400 text-white rounded-xl font-medium shadow-lg shadow-sky-500/25 hover:shadow-sky-500/40 disabled:shadow-none transition-all flex items-center justify-center gap-2">
                    <template x-if="loading">
                        <div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                    </template>
                    <template x-if="!loading">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                        </svg>
                    </template>
                    <span x-text="loading ? 'מעבד...' : 'טען טקסט'"></span>
                </button>
            </div>
        </div>
        
        <!-- File Upload Form -->
        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6 slide-in">
            <h2 class="text-lg font-semibold text-slate-700 mb-4 flex items-center gap-2">
                <svg class="w-5 h-5 text-teal-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                </svg>
                העלאת קובץ
            </h2>
            
            <div class="space-y-4">
                <!-- File Source Name -->
                <div>
                    <label class="block text-sm font-medium text-slate-600 mb-1">שם המקור (אופציונלי)</label>
                    <input type="text" x-model="fileSourceName" 
                           class="w-full px-4 py-2.5 rounded-xl border border-slate-200 focus:border-sky-500 focus:ring-2 focus:ring-sky-500/20 outline-none transition-all"
                           placeholder="ברירת מחדל: שם הקובץ">
                </div>
                
                <!-- File Category -->
                <div>
                    <label class="block text-sm font-medium text-slate-600 mb-1">קטגוריה (אופציונלי)</label>
                    <input type="text" x-model="fileCategory" 
                           class="w-full px-4 py-2.5 rounded-xl border border-slate-200 focus:border-sky-500 focus:ring-2 focus:ring-sky-500/20 outline-none transition-all"
                           placeholder="לדוגמה: ספרות">
                </div>
                
                <!-- File Drop Zone -->
                <div class="relative">
                    <div @dragover.prevent="dragOver = true" 
                         @dragleave.prevent="dragOver = false"
                         @drop.prevent="handleDrop($event)"
                         :class="dragOver ? 'border-sky-500 bg-sky-50' : 'border-slate-200 bg-slate-50'"
                         class="border-2 border-dashed rounded-xl p-12 text-center transition-all cursor-pointer"
                         @click="$refs.fileInput.click()">
                        <input type="file" 
                               x-ref="fileInput" 
                               @change="handleFileSelect($event)"
                               accept=".txt,.docx"
                               class="hidden">
                        
                        <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-8 h-8 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                            </svg>
                        </div>
                        
                        <p class="text-slate-600 font-medium">גרור קובץ לכאן</p>
                        <p class="text-slate-400 text-sm mt-1">או לחץ לבחירת קובץ</p>
                        <p class="text-slate-400 text-xs mt-2">TXT, DOCX עד 10MB</p>
                    </div>
                </div>
                
                <!-- Selected File -->
                <div x-show="selectedFile" class="flex items-center gap-3 bg-slate-50 rounded-xl p-4">
                    <div class="w-10 h-10 bg-teal-100 rounded-lg flex items-center justify-center">
                        <svg class="w-5 h-5 text-teal-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                    </div>
                    <div class="flex-1">
                        <div class="font-medium text-slate-700" x-text="selectedFile?.name"></div>
                        <div class="text-sm text-slate-400" x-text="formatFileSize(selectedFile?.size)"></div>
                    </div>
                    <button @click="selectedFile = null" class="p-2 hover:bg-slate-200 rounded-lg transition-colors">
                        <svg class="w-5 h-5 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                
                <!-- Upload Button -->
                <button @click="uploadFile()" 
                        :disabled="fileLoading || !selectedFile"
                        class="w-full px-6 py-3 bg-gradient-to-r from-teal-500 to-teal-600 hover:from-teal-600 hover:to-teal-700 disabled:from-slate-300 disabled:to-slate-400 text-white rounded-xl font-medium shadow-lg shadow-teal-500/25 hover:shadow-teal-500/40 disabled:shadow-none transition-all flex items-center justify-center gap-2">
                    <template x-if="fileLoading">
                        <div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                    </template>
                    <template x-if="!fileLoading">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                        </svg>
                    </template>
                    <span x-text="fileLoading ? 'מעלה...' : 'העלה קובץ'"></span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Success Message -->
    <div x-show="successMessage" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0 transform translate-y-4"
         x-transition:enter-end="opacity-100 transform translate-y-0"
         class="fixed bottom-8 left-1/2 transform -translate-x-1/2 bg-teal-500 text-white px-6 py-4 rounded-xl shadow-lg flex items-center gap-3">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        <span x-text="successMessage"></span>
        <button @click="successMessage = ''" class="p-1 hover:bg-teal-600 rounded-lg transition-colors">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
        </button>
    </div>
    
    <!-- Error Message -->
    <div x-show="errorMessage" 
         x-transition
         class="fixed bottom-8 left-1/2 transform -translate-x-1/2 bg-rose-500 text-white px-6 py-4 rounded-xl shadow-lg flex items-center gap-3">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        <span x-text="errorMessage"></span>
        <button @click="errorMessage = ''" class="p-1 hover:bg-rose-600 rounded-lg transition-colors">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
        </button>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function uploadApp() {
    return {
        // Text input
        sourceName: '',
        category: '',
        textContent: '',
        loading: false,
        
        // File upload
        fileSourceName: '',
        fileCategory: '',
        selectedFile: null,
        dragOver: false,
        fileLoading: false,
        
        // Messages
        successMessage: '',
        errorMessage: '',
        
        async submitText() {
            if (!this.textContent.trim()) return;
            
            this.loading = true;
            this.errorMessage = '';
            
            try {
                const response = await fetch('/api/sources/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: this.sourceName || 'טקסט ללא שם',
                        content: this.textContent,
                        category: this.category || null
                    })
                });
                
                if (!response.ok) throw new Error('שגיאה בטעינת הטקסט');
                
                const data = await response.json();
                this.successMessage = `נטענו ${data.word_count} מילים בהצלחה!`;
                
                // Clear form
                this.sourceName = '';
                this.category = '';
                this.textContent = '';
                
                // Auto-hide message
                setTimeout(() => this.successMessage = '', 5000);
            } catch (error) {
                this.errorMessage = error.message;
                setTimeout(() => this.errorMessage = '', 5000);
            } finally {
                this.loading = false;
            }
        },
        
        handleDrop(event) {
            this.dragOver = false;
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                this.selectedFile = files[0];
            }
        },
        
        handleFileSelect(event) {
            const files = event.target.files;
            if (files.length > 0) {
                this.selectedFile = files[0];
            }
        },
        
        formatFileSize(bytes) {
            if (!bytes) return '';
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        },
        
        async uploadFile() {
            if (!this.selectedFile) return;
            
            this.fileLoading = true;
            this.errorMessage = '';
            
            try {
                const formData = new FormData();
                formData.append('file', this.selectedFile);
                if (this.fileSourceName) formData.append('source_name', this.fileSourceName);
                if (this.fileCategory) formData.append('category', this.fileCategory);
                
                const response = await fetch('/api/sources/upload', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) throw new Error('שגיאה בהעלאת הקובץ');
                
                const data = await response.json();
                this.successMessage = `${data.message} - ${data.word_count} מילים נוספו`;
                
                // Clear form
                this.fileSourceName = '';
                this.fileCategory = '';
                this.selectedFile = null;
                
                setTimeout(() => this.successMessage = '', 5000);
            } catch (error) {
                this.errorMessage = error.message;
                setTimeout(() => this.errorMessage = '', 5000);
            } finally {
                this.fileLoading = false;
            }
        }
    }
}
</script>
{% endblock %}

